---
创建时间: 2026-02-03
最后修改: 2026-02-15
状态:
  - Areas
tags:
  - #automation
  - #ci
  - #codex
  - #coding
  - #github
  - #github-actions
  - #jira
---
# Jira 与 GitHub 自动化: 贴标签触发 Codex 开 PR

> [!summary]
> 给 Jira 工单加一个特定 label, Jira Automation 触发一个 GitHub Actions 工作流。工作流里运行 Codex CLI 自动改代码并开 PR，然后把 PR 链接回写到 Jira 并推进状态。

> [!warning] 默认只开 PR, 不要自动合并
> 让 Codex “提 PR”，让人类“审 PR”，这是最稳的组合。

## 你会得到什么(流程总览)

1. Jira 工单被打上 label(例如 `aswe`)
2. Jira Automation 通过 Webhook 触发 GitHub 的 `workflow_dispatch`
3. GitHub Actions 拉起 Codex CLI 实现工单需求，并提交 commit
4. 自动创建 PR
5. Jira 自动流转到 In Review，并评论 PR 链接

![Full data-flow diagram](https://developers.openai.com/cookbook/assets/images/codex_action.png)

## 前置条件

- Jira: 有项目管理员权限，能创建 Automation rule
- GitHub: 有写权限，能配置 repo secrets，且 `main` 有分支保护(推荐)
- 需要的 secrets:
  - `OPENAI_API_KEY`
  - `JIRA_BASE_URL`, `JIRA_EMAIL`, `JIRA_API_TOKEN`(用于 REST API)

## Step 1: 配置 Jira Automation Rule(触发 GitHub workflow_dispatch)

思路很简单:

- 监听 issue label 变化
- 判断 label 是否包含关键字(例如 `aswe`)
- 条件满足时，向 GitHub Actions 的 `workflow_dispatch` endpoint 发一个 `POST`
- payload 里带上:
  - `issue_key`
  - `issue_summary`
  - `issue_description`(建议做一层清洗，避免换行和引号破坏 JSON/YAML)

![Automation Rule](https://developers.openai.com/cookbook/assets/images/jira_rule.png)

> [!tip]
> Jira 这边能拿到很多 smart values，你可以把组件、优先级、受影响服务等一起传给 workflow，让 Codex 更不容易猜。

## Step 2: 配置 GitHub Actions 工作流(实现, 提交, 开 PR, 回写 Jira)

把下面保存为 `.github/workflows/codex-jira-pr.yml`，按你的仓库做定制。

> [!warning] Jira Transition ID 要改
> `21`/`31` 只是示例。你的 Jira 工作流里“进入 In Progress / In Review”的 transition id 很可能不同，请先用 Jira API 查出来再填。

```yaml
name: Codex Automated PR (from Jira)

on:
  workflow_dispatch:
    inputs:
      issue_key:
        description: "Jira issue key (e.g., PROJ-123)"
        required: true
      issue_summary:
        description: "Issue summary"
        required: true
      issue_description:
        description: "Issue description"
        required: true

permissions:
  contents: write
  pull-requests: write

jobs:
  codex_auto_pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install Codex CLI
        run: npm i -g @openai/codex

      - name: Export inputs
        run: |
          set -euo pipefail
          echo "ISSUE_KEY=${{ github.event.inputs.issue_key }}"        >> "$GITHUB_ENV"
          echo "TITLE=${{ github.event.inputs.issue_summary }}"        >> "$GITHUB_ENV"
          echo "RAW_DESC=${{ github.event.inputs.issue_description }}" >> "$GITHUB_ENV"

          # 清洗描述，避免换行和引号破坏后续命令
          DESC_CLEANED=$(echo "${{ github.event.inputs.issue_description }}" | tr '\n' ' ' | sed "s/\\\"/'/g")
          echo "DESC=$DESC_CLEANED"                                    >> "$GITHUB_ENV"
          echo "BRANCH=codex/${{ github.event.inputs.issue_key }}"     >> "$GITHUB_ENV"

      - name: Jira - Transition to In Progress
        env:
          ISSUE_KEY:      ${{ env.ISSUE_KEY }}
          JIRA_BASE_URL:  ${{ secrets.JIRA_BASE_URL }}
          JIRA_EMAIL:     ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        run: |
          set -euo pipefail
          curl -sS -X POST \
            --url   "$JIRA_BASE_URL/rest/api/3/issue/$ISSUE_KEY/transitions" \
            --user  "$JIRA_EMAIL:$JIRA_API_TOKEN" \
            --header 'Content-Type: application/json' \
            --data  '{"transition":{"id":"21"}}'

      - name: Configure git identity
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name  "github-actions[bot]"

      - name: Codex implement & commit
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ISSUE_KEY: ${{ env.ISSUE_KEY }}
          TITLE: ${{ env.TITLE }}
          DESC: ${{ env.DESC }}
        run: |
          set -euo pipefail

          codex --approval-mode full-auto --no-terminal \
            "Implement Jira ticket $ISSUE_KEY: $TITLE. $DESC"

          git add -A
          git commit -m "feat($ISSUE_KEY): $TITLE" || true

      - id: cpr
        name: Create pull request
        uses: peter-evans/create-pull-request@v6
        with:
          token:  ${{ secrets.GITHUB_TOKEN }}
          base:   main
          branch: ${{ env.BRANCH }}
          title:  "${{ env.TITLE }} (${{ env.ISSUE_KEY }})"
          body: |
            Auto-generated by Codex for Jira **${{ env.ISSUE_KEY }}**.

            ---
            ${{ env.DESC }}

      - name: Jira - Transition to In Review & comment PR link
        env:
          ISSUE_KEY:      ${{ env.ISSUE_KEY }}
          JIRA_BASE_URL:  ${{ secrets.JIRA_BASE_URL }}
          JIRA_EMAIL:     ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          PR_URL:         ${{ steps.cpr.outputs.pull-request-url }}
        run: |
          set -euo pipefail

          curl -sS -X POST \
            --url   "$JIRA_BASE_URL/rest/api/3/issue/$ISSUE_KEY/transitions" \
            --user  "$JIRA_EMAIL:$JIRA_API_TOKEN" \
            --header 'Content-Type: application/json' \
            --data  '{"transition":{"id":"31"}}'

          curl -sS -X POST \
            --url   "$JIRA_BASE_URL/rest/api/3/issue/$ISSUE_KEY/comment" \
            --user  "$JIRA_EMAIL:$JIRA_API_TOKEN" \
            --header 'Content-Type: application/json' \
            --data  "{\"body\":{\"type\":\"doc\",\"version\":1,\"content\":[{\"type\":\"paragraph\",\"content\":[{\"type\":\"text\",\"text\":\"PR created: $PR_URL\"}]}]}}"
```

## Step 3: 使用方式(给工单贴 label)

把特殊 label(例如 `aswe`) 加到任意 bug/feature 工单上:

1. 新建工单时直接加 label
2. 已有工单，在 Labels 里补上 label

![Adding a label](https://developers.openai.com/cookbook/assets/images/add_label.png)

## 常见坑与安全建议

- secrets: 只放在 GitHub Secrets/Jira Secrets，永远不要写进仓库。
- transition id: 不同 Jira 工作流不一样，一定要按你的项目查。
- prompt: 强调“最小修改 + 必须跑测试”，避免它大重构。
- PR 策略: 强烈建议只创建 PR，不要自动 merge。

## 参考

- Codex CLI: https://github.com/openai/codex
