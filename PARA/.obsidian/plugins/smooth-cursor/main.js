/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var E=Object.defineProperty;var M=Object.getOwnPropertyDescriptor;var S=Object.getOwnPropertyNames;var L=Object.prototype.hasOwnProperty;var D=(b,m)=>{for(var e in m)E(b,e,{get:m[e],enumerable:!0})},N=(b,m,e,s)=>{if(m&&typeof m=="object"||typeof m=="function")for(let t of S(m))!L.call(b,t)&&t!==e&&E(b,t,{get:()=>m[t],enumerable:!(s=M(m,t))||s.enumerable});return b};var F=b=>N(E({},"__esModule",{value:!0}),b);var R={};D(R,{default:()=>C});module.exports=F(R);var T=require("obsidian");var y=require("obsidian"),w=class extends y.PluginSettingTab{constructor(e,s){super(e,s);this.plugin=s}display(){let{containerEl:e}=this;e.empty(),new y.Setting(e).setName("\u62D6\u5C3E\u5F00\u5173 Trail enable").setDesc("\u662F\u5426\u542F\u7528\u62D6\u5C3E").addToggle(s=>s.setValue(this.plugin.setting.enableTrail).onChange(async t=>{this.plugin.setting.enableTrail=t,await this.plugin.saveSettings()})),new y.Setting(e).setName("\u62D6\u5C3E\u989C\u8272 Trail color").setDesc("\u8BBE\u7F6E\u62D6\u5C3E\u989C\u8272").addColorPicker(s=>{s.setValue(this.plugin.setting.trailColor).onChange(async t=>{this.plugin.setting.trailColor=t,await this.plugin.saveSettings()})}),new y.Setting(e).setName("\u62D6\u5C3E\u901F\u5EA6 Trail speed").setDesc("\u8BBE\u7F6E\u62D6\u5C3E\u66F4\u65B0\u6B21\u6570\uFF0C\u8D8A\u5927\u8D8A\u6162 More bigger,more slower").addText(s=>{s.inputEl.type="number",s.setPlaceholder("\u989C\u8272\u5B57\u7B26\u4E32\u6216\u989C\u8272\u4EE3\u7801").setValue(this.plugin.setting.trailStep.toString()).onChange(async t=>{this.plugin.setting.trailStep=parseInt(t),await this.plugin.saveSettings()})})}};var O={trailStep:30,enableTrail:!0,trailColor:"#78dce8",trailColorDark:"#78dce8"},C=class extends T.Plugin{constructor(){super(...arguments);this.fileIndex={};this.editorDom={};this.observer=null;this.settingObserver=null;this.canvas={};this.cursor={};this.vimText={};this.isMouseDown=!1;this.mouseForX={down:0,move:0};this.mouseForY={down:0,move:0};this.isScroll=!1;this.focus=!0;this.closeSettings=!1;this.events={};this.lastPos=[{x:0,y:0,height:0}];this.lastPosForChangeFile=[{x:0,y:0,height:0}];this.rectangle=[{x:0,y:0,dirX:0,dirY:0,extTarget:0,extOrigin:0}];this.trailCount=[];this.isFirstTrail={};this.ctx=null;this.lastRect={x:0,y:0,width:0,height:0}}async onload(){console.log("Smooth Cursor loaded"),await this.loadSettings(),this.addSettingTab(new w(this.app,this)),this.app.workspace.onLayoutReady(()=>{let e=this.getAllOpenFilePaths(),s=this.app.workspace.getActiveFile();s&&(this.fileIndex[s.path]=Object.keys(this.fileIndex).length,this.isFirstTrail[0]=!0),this.registerEvent(this.app.workspace.on("file-open",t=>{if(t!==null){for(let i=0;i<e.length;i++)this.uninit(this.fileIndex[e[i]]),delete this.fileIndex[e[i]];e=this.getAllOpenFilePaths(),this.fileIndex[t.path]=Object.keys(this.fileIndex).length,this.delayedFrames(()=>{this.init(this.fileIndex[t.path])},10)}else this.lastPosForChangeFile=[{x:0,y:0,height:0}],this.events={},this.uninit(0)})),this.init(0)})}onunload(){var e,s;for(let t=0;t<Object.keys(this.cursor).length;t++)(e=this.cursor[t])==null||e.remove();for(let t=0;t<Object.keys(this.canvas).length;t++)(s=this.canvas[t])==null||s.remove();this.stopObserving(),console.log("Smooth Cursor unloaded")}getAllOpenFilePaths(){let e=this.app.workspace.getLeavesOfType("markdown"),s=[];for(let t of e){let i=t.view;i instanceof T.MarkdownView&&i.file&&s.push(i.file.path)}return s}isVimMode(){return document.querySelector(".cm-vimCursorLayer")!==null}isVisible(e){return!!e.offsetParent}eventRegister(e,s,t){let i=this.events[s];i||(i=t,this.events[s]=i),this.registerDomEvent(e,s,i)}uninit(e){var s,t;(s=this.cursor[e])==null||s.remove(),(t=this.canvas[e])==null||t.remove(),this.isFirstTrail[e]=!0,delete this.cursor[e],delete this.canvas[e],this.trailCount[e]=0,this.stopObserving()}init(e){var r,d;let s=(r=this.app.workspace.getActiveViewOfType(T.MarkdownView))==null?void 0:r.leaf.view.containerEl.querySelector(".cm-editor");if(this.editorDom[e]=s,this.test=s.getBoundingClientRect(),!this.editorDom){console.error("\u672A\u6253\u5F00\u6587\u6863");return}let t=this.app.workspace.containerEl.createDiv({cls:"smooth-cursor-busyo"});this.cursor[e]=t,t.id="smooth-cursor-busyo-"+e,this.editorDom[e].appendChild(t);let i=this.app.workspace.containerEl.createDiv();this.vimText[e]=i,t.appendChild(i),i.classList.add("vim-text"),this.delayedFrames(()=>{let o=document.querySelectorAll("style"),h="smooth-cursor-busyo",u="vim-text";for(let c=0;c<o.length;c++){let p=o[c],v=p.textContent;v.includes(h)&&(this.customStyle=p),v.includes(u)&&(this.vimStyle=p)}},10),this.setting.enableTrail||(d=this.cursor[e])==null||d.addClass("show"),this.createTrail(e),this.eventRegister(this.editorDom[e],"mousedown",o=>{var h;this.isMouseDown=!0,this.mouseForX.down=o.clientX,this.mouseMoveTaget={down:o.target,move:o.target},this.mouseForY.down=((h=this.updateCursor(e))==null?void 0:h.y)||0});let n=20,l=0,a=0;this.eventRegister(this.editorDom[e],"mousemove",o=>{var h;a=Date.now(),this.isMouseDown&&a-l>n&&(this.mouseMoveTaget.move=o.target,this.mouseForX.move=o.clientX,this.mouseForY.move=((h=this.updateCursor(e))==null?void 0:h.y)||0,l=a)}),this.eventRegister(this.editorDom[e],"mouseup",()=>{this.isMouseDown=!1,this.updateCursor(e)}),this.eventRegister(this.editorDom[e],"keydown",o=>{let h=this.updateCursor(e)}),this.eventRegister(this.editorDom[e],"keyup",()=>{let o=this.updateCursor(e)}),this.eventRegister(this.editorDom[e],"compositionstart",o=>{let h=this.updateCursor(e)}),this.eventRegister(this.editorDom[e],"compositionupdate",o=>{let h=this.updateCursor(e)}),this.eventRegister(this.editorDom[e],"compositionend",o=>{let h=this.updateCursor(e)}),this.registerEvent(this.app.workspace.on("resize",()=>{this.canvas[e]&&(this.canvas[e].width=window.innerWidth,this.canvas[e].height=window.innerHeight),this.isScroll=!0,this.updateCursor(e)})),this.eventRegister(this.editorDom[e].querySelector(".cm-scroller"),"scroll",()=>{this.isScroll=!0,this.updateCursor(e)}),this.lastPos=this.lastPosForChangeFile,this.startObserving(e),this.registerEvent(this.app.workspace.on("active-leaf-change",o=>{var h,u;o&&o.view.containerEl.contains(this.editorDom[e])?(this.focus=!0,document.body.addClass("caret-hide"),(h=this.cursor[e])==null||h.addClass("show")):(this.focus=!1,document.body.removeClass("caret-hide"),(u=this.cursor[e])==null||u.removeClass("show"))})),this.updateCursor(e),document.body.addClass("caret-hide")}updateCursor(e){var d,o;if(!this.cursor[e]||!this.customStyle||this.curEditor!=this.app.workspace.activeEditor){this.curEditor=this.app.workspace.activeEditor;return}let t=window.getSelection().getRangeAt(0).commonAncestorContainer,i=!1;t.nodeType===Node.ELEMENT_NODE?i=t.classList.contains("inline-title"):t.nodeType===Node.TEXT_NODE&&(i=t.parentElement.classList.contains("inline-title")),this.closeSettings=!1;let n=this.getCursorPosition(e,i);if(n.x==-1&&n.y==-1){this.focus=!1,(d=this.cursor[e])==null||d.removeClass("show");return}else this.focus=!0,(o=this.cursor[e])==null||o.addClass("show");let l=window.scrollX||document.documentElement.scrollLeft,a=window.scrollY||document.documentElement.scrollTop;if(this.isScroll?this.cursor[e].addClass("noTrans"):this.cursor[e].removeClass("noTrans"),this.isVimMode()){let h=this.getNextCharAfterCursor(i);h?(this.vimText&&(this.vimText[e].textContent=h.text),this.vimStyle.textContent=this.vimStyle.textContent.replace(/(--vim-font-size:\s*[^;]+;)/,`--vim-font-size: ${h.size};`)):this.vimText&&(this.vimText[e].textContent="")}else this.vimText&&(this.vimText[e].textContent="");let r=this.customStyle.textContent.replace(/(--cursor-x:\s*[^;]+;)/,`--cursor-x: ${n.x+l};`);return r=r.replace(/(--cursor-y:\s*[^;]+;)/,`--cursor-y: ${n.y+a};`),r=r.replace(/(--cursor-height:\s*[^;]+;)/,`--cursor-height: ${n.height};`),this.customStyle.textContent=r,this.setting.enableTrail&&!this.isScroll&&this.lastPos[e]&&(this.lastPos[e].x!=n.x||this.lastPos[e].y!=n.y)&&this.updateTrail(e,this.lastPos[e].x,this.lastPos[e].y,n.x,n.y,n.height,this.lastPos[e].height),this.setting.enableTrail&&this.cursor[e].hasClass("noAni")?this.cursor[e].removeClass("noAni"):this.setting.enableTrail||(this.cursor[e].addClass("noAni"),setTimeout(()=>{var h;(h=this.cursor[e])==null||h.removeClass("noAni")},80)),this.lastPos[e]=n,this.editorDom[e].getBoundingClientRect().width!==0&&(this.lastPosForChangeFile[e]=n),this.isScroll=!1,n}getNextCharAfterCursor(e){var s;if(e)return null;{let t=(s=this.app.workspace.activeEditor)==null?void 0:s.editor,i=t==null?void 0:t.cm;if(i&&t){let n=t.getCursor(),l=i.state.doc,a=l.lines;if(!(n.line+1>=a)){let r=l.line(n.line+1),d=Math.min(n.ch,r.length),o=r.from+d;if(o<r.to){let h=l.sliceString(o,o+1),u=i.coordsAtPos(o);if(u){let c=document.elementFromPoint(u.left,u.top);if(c){let p=window.getComputedStyle(c).fontSize;return{text:h,size:p}}}}else return null}}}}getCursorPosition(e,s){var i,n;let t=this.editorDom[e].getBoundingClientRect();if(s){let r=window.getSelection().getRangeAt(0).getClientRects()[0],d=this.mouseForX.move<=this.mouseForX.down;return{x:r.x+(d?0:r.width)+window.scrollX-t.x,y:r.y+window.scrollY-t.y,height:r.height}}else{let l=(i=this.app.workspace.activeEditor)==null?void 0:i.editor,a=l==null?void 0:l.cm;if(a&&l){let r=l.getCursor(),d=a.state.doc.line(r.line+1).from+r.ch,o=a.coordsForChar(d);if(!o){let u=window.getSelection().getRangeAt(0),c=u.commonAncestorContainer,p=!1,v=c;for(;v&&(v.nodeType===Node.ELEMENT_NODE?p=Array.from(v.classList).some(g=>g.includes("table")):v.nodeType===Node.TEXT_NODE&&(p=Array.from(v.parentElement.classList).some(g=>g.includes("table"))),!p);)v=v.parentNode;if(p){if((!this.mouseMoveTaget||this.mouseMoveTaget.down.textContent===this.mouseMoveTaget.move.textContent)&&c.nodeType===Node.TEXT_NODE){let g=this.mouseForX.move<=this.mouseForX.down,f=document.createRange();f.setStart(c,g?u.startOffset:u.endOffset),f.setEnd(c,g?u.startOffset:u.endOffset);let x=f.getBoundingClientRect();return{x:x.x+(g?0:x.width)+window.scrollX-t.x,y:x.y+window.scrollY-t.y,height:x.height}}}else{let g=a.domAtPos(d);if(c=g.node,!((n=c.parentElement)!=null&&n.classList.contains("cm-contentContainer"))){if(c.nodeType===Node.ELEMENT_NODE){let f=c.getClientRects();f.length>0&&(o=f[f.length-1])}else if(c.nodeType===Node.TEXT_NODE){let f=document.createRange();f.setStart(c,g.offset),f.setEnd(c,g.offset);let x=f.getBoundingClientRect();(x.width||x.height)&&(o=x)}}}}if(o)return{x:o.left+window.scrollX-t.x,y:o.top+window.scrollY-t.y,height:o.bottom-o.top}}}return{x:-1,y:-1,height:0}}startObserving(e){let s=document.querySelector(".cm-contentContainer");for(;!s;)s=document.querySelector(".cm-contentContainer");this.observer=new MutationObserver(t=>{var n,l;let i=!1;for(let a of t)if(a.type==="childList"){for(let r=0;r<a.addedNodes.length;r++)if(a.addedNodes[r].nodeName!="BR"&&!((n=a.addedNodes[r].classList)!=null&&n.contains("table-cell-wrapper"))){i=!0;break}for(let r=0;r<a.removedNodes.length;r++)if(a.removedNodes[r].nodeName!="BR"&&!((l=a.removedNodes[r].classList)!=null&&l.contains("table-cell-wrapper"))){i=!0;break}}i&&this.delayedFrames(()=>{this.updateCursor(e)})}),this.settingObserver=new MutationObserver(t=>{var i,n,l;for(let a of t)if(a.type==="childList"){for(let r=0;r<a.addedNodes.length;r++)if(a.addedNodes[r].nodeName=="DIV"&&((i=a.addedNodes[r].classList)!=null&&i.contains("modal-container"))){this.focus=!1,document.body.removeClass("caret-hide"),(n=this.cursor[e])==null||n.removeClass("show");break}for(let r=0;r<a.removedNodes.length;r++)if(a.removedNodes[r].nodeName=="DIV"&&((l=a.removedNodes[r].classList)!=null&&l.contains("modal-container"))){this.focus=!0,document.body.addClass("caret-hide"),this.closeSettings=!0;break}}}),this.observer.observe(s,{childList:!0,subtree:!0}),this.settingObserver.observe(document.body,{childList:!0,subtree:!0})}stopObserving(){var e,s;(e=this.observer)==null||e.disconnect(),this.observer=null,(s=this.settingObserver)==null||s.disconnect(),this.settingObserver=null}delayedFrames(e,s=2){let t=0,i=this,n=()=>{t++,t===s?e.call(i):requestAnimationFrame(n)};requestAnimationFrame(n)}createTrail(e){this.canvas[e]=this.editorDom[e].createEl("canvas",{cls:"smooth-cursor-busyo-canvas"}),this.canvas[e].id="trail-canvas-"+e,this.ctx=this.canvas[e].getContext("2d");let s=this.editorDom[e].getBoundingClientRect();this.canvas[e].width=s.width,this.canvas[e].height=s.height}drawTrail(e){if(!this.ctx)return;this.trailCount[e]--;let s=this.trailCount[e]/this.setting.trailStep,t=this.rectangle[e].x-this.rectangle[e].dirX*.15*Math.max(0,-.3+s),i=t,n=this.rectangle[e].x-this.rectangle[e].dirX*s,l=n;this.rectangle[e].dirX===3?(t=this.rectangle[e].x,i=t,n=this.rectangle[e].x-this.rectangle[e].dirX,l=n):this.rectangle[e].dirY<0?(i=this.rectangle[e].x-this.rectangle[e].dirX*.05*Math.max(0,-.3+s),n=this.rectangle[e].x-this.rectangle[e].dirX*Math.max(0,s-.02)):this.rectangle[e].dirY>0&&(t=this.rectangle[e].x-this.rectangle[e].dirX*.05*Math.max(0,-.3+s),l=this.rectangle[e].x-this.rectangle[e].dirX*Math.max(0,s-.02));let a=this.rectangle[e].extTarget-this.rectangle[e].extOrigin;this.ctx.clearRect(this.lastRect.x,this.lastRect.y,this.lastRect.width,this.lastRect.height),this.ctx.beginPath(),this.ctx.moveTo(t,this.rectangle[e].y+this.rectangle[e].extTarget),this.ctx.lineTo(i,this.rectangle[e].y),this.ctx.lineTo(n,this.rectangle[e].y-this.rectangle[e].dirY*s),this.ctx.lineTo(l,this.rectangle[e].y-this.rectangle[e].dirY*s+this.rectangle[e].extTarget-a*s),this.ctx.closePath(),this.ctx.fillStyle=this.setting.trailColor,this.ctx.fill();let r=Math.min(t,i,n,l),d=Math.max(t,i,n,l),o=Math.min(this.rectangle[e].y-this.rectangle[e].dirY*s,this.rectangle[e].y,this.rectangle[e].y+this.rectangle[e].extTarget,this.rectangle[e].y-this.rectangle[e].dirY*s+this.rectangle[e].extTarget-a*s),h=Math.max(this.rectangle[e].y-this.rectangle[e].dirY*s,this.rectangle[e].y,this.rectangle[e].y+this.rectangle[e].extTarget,this.rectangle[e].y-this.rectangle[e].dirY*s+this.rectangle[e].extTarget-a*s);this.lastRect.x=r-50,this.lastRect.y=o-50,this.lastRect.width=d+50,this.lastRect.height=h+50}animate(e){if(Object.keys(this.canvas).length!==0&&!(!this.canvas[e]||!this.rectangle[e]||this.ctx===null)){if(this.cursor[e]&&this.trailCount[e]!=null&&this.trailCount[e]<=0){this.ctx.clearRect(0,0,this.canvas[e].width,this.canvas[e].height),this.focus&&!this.closeSettings&&this.cursor[e].addClass("show");return}this.drawTrail(e),requestAnimationFrame(()=>this.animate(e))}}updateTrail(e,s,t,i,n,l,a){if(!this.cursor[e])return;if(this.isFirstTrail[e]){this.isFirstTrail[e]=!1,this.cursor[e].addClass("show");return}let r=i-s,d=n-t;this.rectangle[e]||(this.rectangle[e]={x:0,y:0,dirX:0,dirY:0,extTarget:0,extOrigin:0}),this.rectangle[e].x=i,this.rectangle[e].y=n,this.rectangle[e].dirX=r==0?3:r,this.rectangle[e].dirY=d,this.rectangle[e].extTarget=l,this.rectangle[e].extOrigin=a,this.trailCount[e]=this.setting.trailStep,this.cursor[e].removeClass("show"),this.animate(e)}async loadSettings(){this.setting=Object.assign({},O,await this.loadData())}async saveSettings(){await this.saveData(this.setting)}updateSetting(){this.cursor}};

/* nosourcemap */